<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <meta name="name" content="Concept Map" />
    <meta name="description" content="An abstract mapping for parameters. Works best if first tag is 'unique' among the tracklist, and the second tag applies to multiple tracks"/>
    <meta name="mintags" content="2" />
    <meta name="maxtags" content="2" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <title>Question Centric Page</title>

    <style>
        /* tag for text font
        color : "#ffffff"; // text color
        fill : "#ffffff" // fill color
        stroke : "#ffffff" // border color
        stroke-width : 4px // border width
        */
        svg {
            font: 15px sans-serif;
        }
        /* tag for all text */
        text {
            pointer-events: all;
        }
        /* tag for inner rectangle*/
        .inner_node rect {
            pointer-events: all;
            stroke: #222
        }

        /*for rectangles number inside */
        .inner_node rect.highlight {
            stroke: #8CBA80;
            stroke-width: 4px;
        }
        /* tag for outer circle*/
        .outer_node circle {
            fill: #658E9C;
            stroke-width: 1px;
            pointer-events: all;
        }

        .outer_node circle.highlight
        {
            fill: #003200;
            stroke-width: 2px;
        }

        .link {
            fill: none;
        }

        /* tag for inner circle*/
        .inner_circle circle {
            ill: #306eff;
            stroke: #b45033;
            stroke-width: 1.5px;
            pointer-events: all;
        } 

        .inner_circle circle.highlight
        {
            stroke: #315B7E;
            stroke-width: 4px;
        }

        .no-js #loader { display: none;  }
        .js #loader { display: block; position: absolute; left: 100px; top: 0; }
        .se-pre-con {
            position: fixed;
            left: 0px;
            top: 0px;
            width: 100%;
            height: 100%;
            z-index: 9999;
            background: url("Preloader_3.gif") center no-repeat #fff;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.2/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.2/modernizr.js"></script>
</head>
<body onload="loaddata2()">
<div class="se-pre-con"></div>
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header">
            <a class="navbar-brand" href="#"><span class="glyphicon glyphicon-tasks"></span> &nbsp; Stack Overflow Recommender</a>
        </div>
        <ul class="nav navbar-nav navbar-right">
            <li><a href="index.html"><span class="glyphicon glyphicon-home"></span>&nbsp;Home</a></li>
        </ul>
    </div>
</nav>
<div id="mainbody"></div>
<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="scripts/data.js"></script>
<script>
    //
    // Generated by the Exaile Playlist Analyzer plugin.
    // (C) 2014 Dustin Spicuzza <dustin@virtualroadside.com>
    //
    // This work is licensed under the Creative Commons Attribution 4.0
    // International License. To view a copy of this license, visit
    // https://creativecommons.org/licenses/by/4.0/.
    //
    // Inspired by https://www.findtheconversation.com/concept-map/
    // Loosely based on https://bl.ocks.org/mbostock/4063550
    //
    function ajaxmagic() {
        var mess = "";
        var datam = questionsToTags;
        $.ajax({
            url: 'https://ec2-35-163-152-231.us-west-2.compute.amazonaws.com:5000/questionToTags/',
            method: 'GET', // or GET
            success: function(msg) {
                mess = JSON.parse(msg);
                postProcess(mess);
                $(".se-pre-con").fadeOut("slow");
            },
            error: function (request, status, error) {
                if(status == 'error') {
                    alert("Something Wrong Happened. Please Try again later");
                }
                $(".se-pre-con").fadeOut("slow");
            }
        });
    }

    function savingTag(d){
        var tagName = d.name;
        $.ajax({
            url: 'https://ec2-35-163-152-231.us-west-2.compute.amazonaws.com:5000/writeAfterSecond/'+tagName,
            method: 'GET', // or GET
            success: function(msg) {
                onclick();
            },
            error: function (request, status, error) {
                if(status == 'error') {
                    alert("Something Wrong Happened. Please Try again later");
                }
            }
        });


    }

    function postProcess(mess) {
        conceptmap(mess);
    }

    function loaddata2() {
        ajaxmagic();
    }

function conceptmap(ques) {

    var data = ques;
    // transform the data into a useful representation
    // transform the data into a useful representation
    // 1 is inner, 2, is outer

    // need: inner, outer, links
    //
    // inner:
    // links: { inner: outer: }


    var outer = d3.map();
    var inner = [];
    var links = [];

    var outerId = [0];

    data.forEach(function(d){

        if (d == null)
            return;
        var names = []
        var tags = []
        var qids = []
        d.forEach(function(d1){
            names.push(d1[1]);
            qids.push(d1[0]);
            d1[2].forEach(function(d2){
                tags.push(d2);
            });
        });
        i = { id: 'i' + inner.length, name: names, related_links: [], qid: qids };
        i.related_nodes = [i.id];
        inner.push(i);

        tags.forEach(function(d1){

            o = outer.get(d1);

            if (o == null)
            {
                o = { name: d1,	id: 'o' + outerId[0], related_links: [] };
                o.related_nodes = [o.id];
                outerId[0] = outerId[0] + 1;

                outer.set(d1, o);
            }

            // create the links
            l = { id: 'l-' + i.id + '-' + o.id, inner: i, outer: o }
            links.push(l);

            // and the relationships
            i.related_nodes.push(o.id);
            i.related_links.push(l.id);
            o.related_nodes.push(i.id);
            o.related_links.push(l.id);
        });
    });

    data = {
        inner: inner,
        outer: outer.values(),
        links: links
    }

    // sort the data -- TODO: have multiple sort options
    outer = data.outer;
    data.outer = Array(outer.length);


    var i1 = 0;
    var i2 = outer.length - 1;

    for (var i = 0; i < data.outer.length; ++i)
    {
        if (i % 2 == 1)
            data.outer[i2--] = outer[i];
        else
            data.outer[i1++] = outer[i];
    }

    console.log(data.outer.reduce(function(a,b) { return a + b.related_links.length; }, 0) / data.outer.length);


    // from d3 colorbrewer:
    // This product includes color specifications and designs developed by Cynthia Brewer (https://colorbrewer.org/).
    var colors = ["#a50026","#d73027","#f46d43","#fdae61","#fee090","#ffffbf","#e0f3f8","#abd9e9","#74add1","#4575b4","#313695"]
    var colorsForRect = ["#0000ff", "#00ff00"]
    var color = d3.scale.linear()
            .domain([60, 220])
            .range([colors.length-1, 0])
            .clamp(true);

    var diameter = 700;
    var rect_width = 100;
    var rect_height = 18;

    var link_width = "0.75px";

    var il = data.inner.length;
    var ol = data.outer.length;

    var inner_y = d3.scale.linear()
            .domain([0, il])
            .range([-(il * rect_height)/2, (il * rect_height)/2]);

    mid = (data.outer.length/2.0)
    var outer_x = d3.scale.linear()
            .domain([0, mid, mid, data.outer.length])
            .range([15, 170, 190 ,355]);

    var outer_y = d3.scale.linear()
            .domain([0, data.outer.length])
            .range([0, diameter / 2 - 120]);


    // setup positioning
    data.outer = data.outer.map(function(d, i) {
        d.x = outer_x(i);
        d.y = diameter/3;
        return d;
    });

    data.inner = data.inner.map(function(d, i) {
        d.x = -(rect_width / 2);
        d.y = inner_y(i);
        return d;
    });



    var diagonal = d3.svg.diagonal()
            .source(function(d) { return {"x": d.outer.y * Math.cos(projectX(d.outer.x)),
                "y": -d.outer.y * Math.sin(projectX(d.outer.x))}; })
            .target(function(d) { return {"x": d.inner.y + rect_height/2,
                "y": d.outer.x > 180 ? d.inner.x : d.inner.x + rect_width}; })
            .projection(function(d) { return [d.y, d.x]; });


    var svg = d3.select("#mainbody").append("svg")
            .attr("width", diameter + 100)
            .attr("height", diameter + 100)
            .append("g")
            .attr("transform", "translate(" + (diameter + 200)/ 2 + "," + (diameter + 50)/ 2 + ")");


    // links
    var link = svg.append('g').attr('class', 'links').selectAll(".link")
            .data(data.links)
            .enter().append('path')
            .attr('class', 'link')
            .attr('id', function(d) { return d.id })
            .attr("d", diagonal)
            .attr('stroke', function(d) { return get_color(d.inner.name); })
            .attr('stroke-width', link_width);

    // outer nodes

    var onode = svg.append('g').selectAll(".outer_node")
            .data(data.outer)
            .enter().append("g")
            .attr("class", "outer_node")
            .attr("transform", function(d) { return "rotate(" + (d.x - 90) + ")translate(" + d.y + ")"; })
            .on("mouseover", mouseover)
            .on("mouseout", mouseout)
            .on("click", savingTag);

    onode.append("circle")
            .attr('id', function(d) { return d.id })
            .attr("r", 13);

    onode.append("circle")
            .attr('r', 13)
            .attr('visibility', 'hidden');

    onode.append("text")
            .attr('id', function(d) { return d.id + '-txt'; })
            .attr("dy", ".31em")
            .attr("text-anchor", function(d) { return d.x < 180 ? "start" : "end"; })
            .attr("transform", function(d) { return d.x < 180 ? "translate(15)" : "rotate(180)translate(-15)"; })
            .attr("fill", "#4D5382")
            .text(function(d) { return d.name; });

    // inner nodes

    var inode = svg.append('g').selectAll(".inner_node")
            .data(data.inner)
            .enter().append("g")
            .attr("class", "inner_node")
            .attr('margin', '2px')
            .attr("transform", function(d, i) { return "translate(" + d.x + "," + d.y + ")"})
            .on("mouseover", mouseover)
            .on("mouseout", mouseout)


    inode.append('rect')
            .attr('width', rect_width)
            .attr('height', rect_height)
            .attr('id', function(d) { return d.id; })
            .attr('fill', function(d) { return get_color_rect(d.name); });

    inode.append('circle')
            .attr('r', 6)
            .attr('id', function(d) { return d.id + 'innercircle    '; })
            .attr('fill', function(d) { return "#000000"; })
            .attr('class', 'inner_circle')
            .attr("transform", "translate(" + rect_width/5 + "," + rect_height*0.5+ ")")
            .append("title").text(function (d)  {
            console.log(d);
            return d.name[0];
    });

    inode.append('text')
            .text("?")
            .style("fill", "#ffffff")
            .attr("font-size", "10px")
            .attr("text-style", "bold")
            .attr("transform", "translate(" + ( rect_width/5 - 3) + "," + rect_height*0.7+ ")")
    .append("title").text(function (d)  {
        return d.name[0];
    });
    inode.append('circle')
            .attr('r', 6)
            .attr('id', function(d) { return d.id + 'innercircle    '; })
            .attr('fill', function(d) { return "#000000"; })
            .attr('class', 'inner_circle')
            .attr("transform", "translate(" + rect_width*2/5 + "," + rect_height*0.5+ ")")
    .append("title").text(function (d)  {
        return d.name[1];
    });
    inode.append('text')
            .text("?")
            .style("fill", "#ffffff")
            .attr("font-size", "10px")
            .attr("text-style", "bold")
            .attr("transform", "translate(" + ( 2 * rect_width/5 - 3) + "," + rect_height*0.7+ ")")
    .append("title").text(function (d)  {
        return d.name[1];
    });
    inode.append('circle')
            .attr('r', 6)
            .attr('id', function(d) { return d.id + 'innercircle    '; })
            .attr('fill', function(d) { return "#000000"; })
            .attr('class', 'inner_circle')
            .attr("transform", "translate(" + rect_width*3/5+ "," + rect_height*0.5+ ")")
    .append("title").text(function (d)  {
        return d.name[2];
    });
    inode.append('text')
            .text("?")
            .style("fill", "#ffffff")
            .attr("font-size", "10px")
            .attr("text-style", "bold")
            .attr("transform", "translate(" + ( 3 * rect_width/5 - 3) + "," + rect_height*0.7+ ")")
    .append("title").text(function (d)  {
        return d.name[2];
    });
    inode.append('circle')
            .attr('r', 6)
            .attr('id', function(d) { return d.id + 'innercircle    '; })
            .attr('fill', function(d) { return "#000000"; })
            .attr('class', 'inner_circle')
            .attr("transform", "translate(" + rect_width*4/5 + "," + rect_height*0.5+ ")")
    .append("title").text(function (d)  {
        return d.name[3];
    });
    inode.append('text')
            .text("?")
            .style("fill", "#ffffff")
            .attr("font-size", "10px")
            .attr("text-style", "bold")
            .attr("transform", "translate(" + ( 4 * rect_width/5 - 3) + "," + rect_height*0.7+ ")")
    .append("title").text(function (d)  {
        return d.name[3];
    });

    inode.append('rect')
            .on("click", function (d) {
                onclickCircle(d.qid[0])
            })
            .attr('width', 15)
            .attr('height', rect_height)
            .attr('transform', 'translate(' + (rect_width/5 - 6)+ ",0)")
            .attr('visibility','hidden')
            .append("title").text(function (d)  {
                 return d.name[0];
            });
    inode.append('rect')
            .on("click", function (d) {
                onclickCircle(d.qid[0])
            })
            .attr('width', 15)
            .attr('height', rect_height)
            .attr('transform', 'translate(' + (2 * rect_width/5 - 6)+ ",0)")
            .attr('visibility','hidden')
            .append("title").text(function (d)  {
                return d.name[1];
            });
    inode.append('rect')
            .on("click", function (d) {
                onclickCircle(d.qid[0])
            })
            .attr('width', 15)
            .attr('height', rect_height)
            .attr('transform', 'translate(' + (3 * rect_width/5 - 6)+ ",0)")
            .attr('visibility','hidden')
            .append("title").text(function (d)  {
        return d.name[2];
    });
    inode.append('rect')
            .on("click", function (d) {
                onclickCircle(d.qid[0])
            })
            .attr('width', 15)
            .attr('height', rect_height)
            .attr('transform', 'translate(' + ((4 * rect_width/5) - 6)+ ",0)")
            .attr('visibility','hidden')
            .append("title").text(function (d)  {
        return d.name[3];
    });


    // need to specify x/y/etc
    d3.select(self.frameElement).style("height", diameter - 150 + "px");
    }
    function get_color(name)
    {
        /*var c = Math.round(color(name));
         if (isNaN(c))
         return '#dddddd';	// fallback color

         return colors[c];
         */
        return "#8CBA80";
    }

    function get_color_rect(name)
    {
        if(name == "important") {
            return "#ddd"
        } else {
            return "#ddd"
        }
    }

    // Can't just use d3.svg.diagonal because one edge is in normal space, the
    // other edge is in radial space. Since we can't just ask d3 to do projection
    // of a single point, do it ourselves the same way d3 would do it.


    function projectX(x)
    {
        return ((x - 90) / 180 * Math.PI) - (Math.PI/2);
    }

    function mouseover(d)
    {
        // bring to front
        d3.selectAll('.links .link').sort(function(a, b){ return d.related_links.indexOf(a.id); });

        for (var i = 0; i < d.related_nodes.length; i++)
        {
            d3.select('#' + d.related_nodes[i]).classed('highlight', true);
            d3.select('#' + d.related_nodes[i] + '-txt').attr("font-weight", 'bold');
        }

        for (var i = 0; i < d.related_links.length; i++)
            d3.select('#' + d.related_links[i]).attr('stroke-width', '5px');
    }
    link_width = "0.75px";
    function mouseout(d)
    {
        for (var i = 0; i < d.related_nodes.length; i++)
        {
            d3.select('#' + d.related_nodes[i]).classed('highlight', false);
            d3.select('#' + d.related_nodes[i] + '-txt').attr("font-weight", 'normal');
        }

        for (var i = 0; i < d.related_links.length; i++)
            d3.select('#' + d.related_links[i]).attr('stroke-width', link_width);
    }

    function onclick()
    {
        window.open('TagsOfTags.html',"_self");

    }
    function onclickCircle(d)
    {   
        //savingTag(d.name);
        window.open('QuestionsAndAnswers.html',"_self");
        sessionStorage.setItem("questionid", d);
    }

    //TODO orbital names instead of ids


</script>
<script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
<script src="https://apis.google.com/js/client.js?onload=init"></script>
